<!DOCTYPE html>
<html lang="gl" style="background:#0a0a1a;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Carti√±os">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a1a">
    <meta name="background-color" content="#0a0a1a">
    <!-- iOS Touch Icon & Startup Images -->
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <title>Carti√±os - Xesti√≥n Financeira Persoal</title>
    <!-- Apple Touch Icon 180x180 PNG -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,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">
    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    <link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    <link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    <link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    <link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    <!-- Web App Manifest (inline for GitHub Pages) -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2FydGnDsW9zIiwic2hvcnRfbmFtZSI6IkNhcnRpw7FvcyIsImRlc2NyaXB0aW9uIjoiWGVzdGnDs24gRmluYW5jZWlyYSBQZXJzb2FsIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwYTBhMWEiLCJ0aGVtZV9jb2xvciI6IiMwYTBhMWEiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0LXByaW1hcnkiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHJlY3QgZmlsbD0nJTIzMGEwYTFhJyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgcng9JzIwJy8+PHRleHQgeT0nNjUnIHg9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmb250LXNpemU9JzUwJz7wn5C3PC90ZXh0Pjwvc3ZnPiIsInNpemVzIjoiYW55IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a1a;
            --bg-secondary: #12122a;
            --bg-tertiary: #1a1a3a;
            --bg-card: rgba(26, 26, 58, 0.8);
            --accent-pink: #ff6ec7;
            --accent-cyan: #00f5ff;
            --accent-purple: #a855f7;
            --accent-yellow: #ffd93d;
            --accent-green: #39ff14;
            --accent-orange: #ff9f43;
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0;
            --text-muted: #606080;
            --border-glow: rgba(255, 110, 199, 0.3);
            --shadow-neon: 0 0 20px rgba(255, 110, 199, 0.3), 0 0 40px rgba(0, 245, 255, 0.1);
            --gradient-main: linear-gradient(135deg, #1a1a3a 0%, #0a0a1a 50%, #12122a 100%);
            --gradient-card: linear-gradient(145deg, rgba(40, 40, 80, 0.6) 0%, rgba(20, 20, 50, 0.8) 100%);
            --gradient-button: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-purple) 100%);
        }
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        html { 
            background: #0a0a1a;
            background: linear-gradient(135deg, #1a1a3a 0%, #0a0a1a 50%, #12122a 100%);
            /* Prevent overscroll bounce on iOS */
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }
        html, body { 
            touch-action: manipulation;
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
            /* Prevent pull-to-refresh on iOS standalone */
            overscroll-behavior-y: contain;
        }
        body {
            font-family: 'Rajdhani', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: #0a0a1a;
            background: linear-gradient(135deg, #1a1a3a 0%, #0a0a1a 50%, #12122a 100%);
            background-attachment: fixed;
            color: #ffffff;
            color: var(--text-primary);
            /* iOS height fixes */
            min-height: 100vh;
            min-height: 100dvh;
            min-height: -webkit-fill-available;
            min-height: calc(100vh - env(safe-area-inset-bottom));
            position: relative;
            padding-bottom: 120px;
            padding-bottom: calc(120px + env(safe-area-inset-bottom));
            padding-top: env(safe-area-inset-top);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            /* Prevent text size adjust on rotation */
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        /* iOS Standalone Mode Optimizations */
        @media all and (display-mode: standalone) {
            body {
                /* Extra padding in standalone for home indicator */
                padding-bottom: calc(130px + env(safe-area-inset-bottom));
            }
            .fab-container {
                bottom: calc(30px + env(safe-area-inset-bottom)) !important;
            }
        }
        /* Safari-specific fixes */
        @supports (-webkit-touch-callout: none) {
            /* Fix for Safari 100vh including address bar */
            body {
                min-height: -webkit-fill-available;
            }
            /* Smooth momentum scrolling */
            .notification-list,
            .modal-overlay {
                -webkit-overflow-scrolling: touch;
            }
            /* Input zoom prevention already handled by 16px font-size */
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 245, 255, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(255, 110, 199, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }
        .grid-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                linear-gradient(rgba(0, 245, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 245, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }
        .app-container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }
        header {
            text-align: center;
            padding: 15px 15px 10px;
            margin-bottom: 15px;
        }
        .logo {
            font-family: 'Orbitron', monospace;
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-pink) 0%, var(--accent-cyan) 50%, var(--accent-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.1em;
        }
        .subtitle {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 5px;
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }
        .notification-bell {
            position: fixed;
            top: 15px;
            top: calc(15px + env(safe-area-inset-top));
            right: 15px;
            right: calc(15px + env(safe-area-inset-right));
            z-index: 100;
            background: #1a1a3a;
            background: var(--bg-tertiary);
            border: 1px solid rgba(255, 110, 199, 0.3);
            border: 1px solid var(--border-glow);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.3rem;
            touch-action: manipulation;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            font-size: 0.65rem;
            font-weight: bold;
            min-width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
        }
        .notification-badge.hidden { display: none; }
        .notification-panel {
            position: fixed;
            top: 70px;
            right: 10px;
            left: 10px;
            max-width: 400px;
            max-height: 70vh;
            background: var(--bg-secondary);
            border: 1px solid var(--border-glow);
            border-radius: 16px;
            z-index: 99;
            overflow: hidden;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        .notification-panel.active { display: block; }
        .notification-header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-glow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notification-title {
            font-family: 'Orbitron', monospace;
            font-size: 0.85rem;
            color: var(--accent-cyan);
        }
        .notification-list {
            max-height: calc(70vh - 50px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .notification-item {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 110, 199, 0.1);
            cursor: pointer;
        }
        .notification-item.unread { border-left: 3px solid var(--accent-cyan); }
        .notification-item-title {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        .notification-item-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .notification-item-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .notif-icon { font-size: 1rem; }
        .notif-warning { color: var(--accent-yellow); }
        .notif-danger { color: #ff4757; }
        .notif-success { color: var(--accent-green); }
        .notif-info { color: var(--accent-cyan); }
        .main-display {
            background: var(--gradient-card);
            border: 1px solid var(--border-glow);
            border-radius: 20px;
            padding: 25px 20px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-neon);
        }
        .main-display-content {
            position: relative;
            z-index: 1;
        }
        .available-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 0.3em;
            margin-bottom: 6px;
        }
        .available-amount {
            font-family: 'Orbitron', monospace;
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 0 0 30px rgba(255, 110, 199, 0.5);
            line-height: 1;
            margin-bottom: 10px;
        }
        .available-amount.negative { color: #ff4757; }
        .available-amount.positive { color: var(--accent-green); }
        .secondary-amount {
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        .secondary-amount span { color: var(--text-secondary); }
        .secondary-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        .info-item { text-align: center; }
        .info-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .info-value {
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        .fab-container {
            position: fixed;
            bottom: 25px;
            bottom: calc(25px + env(safe-area-inset-bottom));
            right: 20px;
            right: calc(20px + env(safe-area-inset-right));
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
        }
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.6rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            touch-action: manipulation;
            -webkit-appearance: none;
            appearance: none;
        }
        .fab:active { transform: scale(0.95); }
        .fab-income {
            background: linear-gradient(135deg, var(--accent-green) 0%, #00b894 100%);
            color: white;
        }
        .fab-expense {
            background: linear-gradient(135deg, var(--accent-pink) 0%, #e84393 100%);
            color: white;
        }
        .fab-transfer {
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-purple) 100%);
            color: white;
            width: 46px;
            height: 46px;
            font-size: 1.2rem;
        }
        .nav-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0 5px;
        }
        .nav-tab {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            touch-action: manipulation;
            -webkit-appearance: none;
        }
        .nav-tab.active {
            background: var(--gradient-button);
            color: var(--text-primary);
            box-shadow: 0 0 15px rgba(255, 110, 199, 0.4);
        }
        .section { display: none; }
        .section.active { display: block; }
        .card {
            background: var(--gradient-card);
            border: 1px solid var(--border-glow);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 15px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 110, 199, 0.2);
            flex-wrap: wrap;
            gap: 10px;
        }
        .card-title {
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .btn {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            touch-action: manipulation;
            -webkit-appearance: none;
            min-height: 44px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary {
            background: var(--gradient-button);
            color: var(--text-primary);
            box-shadow: 0 4px 15px rgba(255, 110, 199, 0.3);
        }
        .btn-secondary {
            background: transparent;
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ff4757 0%, #c0392b 100%);
            color: var(--text-primary);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--accent-green) 0%, #00b894 100%);
            color: var(--text-primary);
        }
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-primary);
            border: 1px solid rgba(255, 110, 199, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Rajdhani', -apple-system, sans-serif;
            /* 16px prevents iOS zoom on focus */
            font-size: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            min-height: 48px;
            /* iOS input shadows */
            -webkit-box-shadow: none;
            box-shadow: none;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.2);
            /* Prevent iOS zoom */
            font-size: 16px;
        }
        .form-input::placeholder { 
            color: var(--text-muted); 
            opacity: 1; /* Firefox fix */
        }
        /* iOS date input fix */
        input[type="date"] {
            -webkit-appearance: none;
            min-height: 48px;
        }
        input[type="date"]::-webkit-date-and-time-value {
            text-align: left;
        }
        /* iOS number input */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(10, 10, 26, 0.6);
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent-pink);
        }
        .list-item-info {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }
        .list-item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            font-size: 0.9rem;
        }
        .list-item-details {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .list-item-amount {
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            font-weight: 600;
            margin-right: 8px;
            white-space: nowrap;
        }
        .list-item-amount.income { color: var(--accent-green); }
        .list-item-amount.expense { color: var(--accent-pink); }
        .list-item-amount.neutral { color: var(--accent-cyan); }
        .list-item-actions { display: flex; gap: 6px; }
        .btn-icon {
            width: 36px;
            height: 36px;
            min-height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 0;
            touch-action: manipulation;
        }
        .checkbox-custom {
            width: 24px;
            height: 24px;
            background: var(--bg-primary);
            border: 2px solid var(--accent-cyan);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .checkbox-custom.checked { background: var(--accent-cyan); }
        .checkbox-custom.checked::after {
            content: '‚úì';
            color: var(--bg-primary);
            font-weight: bold;
            font-size: 0.9rem;
        }
        .toast-container {
            position: fixed;
            bottom: 100px;
            bottom: calc(100px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 350px;
        }
        .toast {
            background: var(--gradient-card);
            border: 1px solid var(--accent-green);
            border-radius: 12px;
            padding: 14px 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            margin-bottom: 8px;
            text-align: center;
        }
        .toast.error { border-color: #ff4757; }
        .toast.warning { border-color: var(--accent-yellow); }
        .toast.info { border-color: var(--accent-cyan); }
        .toast-message { font-size: 0.9rem; color: var(--text-primary); }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: flex-start;
            justify-content: center;
            padding: 20px 15px;
            padding-top: calc(20px + env(safe-area-inset-top));
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            /* Prevent body scroll when modal open */
            overscroll-behavior: contain;
        }
        .modal-overlay.active { 
            display: flex; 
        }
        /* Prevent body scroll when modal is open */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-glow);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 450px;
            margin: auto 0;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        .modal-title {
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            color: var(--accent-cyan);
        }
        .modal-close {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-glow);
            color: var(--text-secondary);
            font-size: 1.3rem;
            cursor: pointer;
            line-height: 1;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .stat-card {
            background: rgba(10, 10, 26, 0.6);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
            border: 1px solid rgba(255, 110, 199, 0.1);
        }
        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .progress-bar {
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-fill {
            height: 100%;
            background: var(--gradient-button);
            border-radius: 3px;
        }
        .progress-fill.success { background: linear-gradient(135deg, var(--accent-green), #00b894); }
        .progress-fill.warning { background: linear-gradient(135deg, var(--accent-yellow), var(--accent-orange)); }
        .progress-fill.danger { background: linear-gradient(135deg, #ff4757, #c0392b); }
        .alert-box {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid #ff4757;
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 15px;
            display: none;
        }
        .alert-box.visible { display: block; }
        .alert-title { font-weight: 700; color: #ff4757; margin-bottom: 4px; font-size: 0.9rem; }
        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-muted);
        }
        .empty-state-icon { font-size: 2rem; margin-bottom: 10px; opacity: 0.5; }
        .chart-container {
            position: relative;
            height: 250px;
            margin: 15px 0;
        }
        .simulator-horizon {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .horizon-btn {
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-glow);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            touch-action: manipulation;
            min-height: 44px;
        }
        .horizon-btn.active {
            background: var(--gradient-button);
            color: var(--text-primary);
        }
        .simulator-alert {
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .simulator-alert.warning { background: rgba(255, 217, 61, 0.1); border: 1px solid var(--accent-yellow); }
        .simulator-alert.danger { background: rgba(255, 71, 87, 0.1); border: 1px solid #ff4757; }
        .simulator-alert.success { background: rgba(57, 255, 20, 0.1); border: 1px solid var(--accent-green); }
        .simulator-alert-icon { font-size: 1.2rem; flex-shrink: 0; }
        .simulator-alert-text { flex: 1; font-size: 0.85rem; }
        .pattern-card {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid var(--accent-purple);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
        }
        .pattern-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .pattern-icon { font-size: 1.2rem; }
        .pattern-title { font-weight: 600; color: var(--accent-purple); font-size: 0.9rem; }
        .pattern-description { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; }
        .pattern-amount { font-family: 'Orbitron', monospace; color: var(--accent-pink); font-weight: 600; }
        .debt-direction { display: flex; gap: 10px; margin-bottom: 15px; }
        .debt-direction-btn {
            flex: 1;
            padding: 12px 10px;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            text-align: center;
            font-size: 0.85rem;
            touch-action: manipulation;
            min-height: 60px;
        }
        .debt-direction-btn.active { border-color: var(--accent-cyan); color: var(--text-primary); }
        .debt-direction-btn .icon { font-size: 1.3rem; display: block; margin-bottom: 4px; }
        .test-status {
            position: fixed;
            top: 10px;
            top: calc(10px + env(safe-area-inset-top));
            left: 10px;
            left: calc(10px + env(safe-area-inset-left));
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.65rem;
            font-family: 'Space Mono', monospace;
            z-index: 100;
        }
        .test-status.pass { background: rgba(57, 255, 20, 0.2); border: 1px solid var(--accent-green); color: var(--accent-green); }
        .test-status.fail { background: rgba(255, 71, 87, 0.2); border: 1px solid #ff4757; color: #ff4757; }
        .tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 6px;
        }
        .tag-bank { background: rgba(0, 245, 255, 0.2); color: var(--accent-cyan); }
        .tag-cash { background: rgba(57, 255, 20, 0.2); color: var(--accent-green); }
        .tag-extra { background: rgba(255, 159, 67, 0.2); color: var(--accent-orange); }
        .piggy-icon { font-size: 2.5rem; margin-bottom: 10px; }
        select.form-select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23a0a0c0' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 35px; }
    </style>
</head>
<body>
    <!-- Loading Splash for PWA -->
    <div id="splashScreen" style="position:fixed;top:0;left:0;right:0;bottom:0;background:#0a0a1a;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;">
        <div style="font-size:4rem;margin-bottom:20px;">üê∑</div>
        <div style="font-family:system-ui,sans-serif;color:#ff6ec7;font-size:1.5rem;letter-spacing:0.2em;">CARTI√ëOS</div>
    </div>
    <div class="grid-overlay"></div>
    <div class="test-status" id="testStatus">‚è≥</div>
    <div class="notification-bell" id="notifBell">üîî<div class="notification-badge hidden" id="notifBadge">0</div></div>
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <span class="notification-title">Notificaci√≥ns</span>
            <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 0.7rem; min-height: 32px;" id="clearNotifsBtn">Limpar</button>
        </div>
        <div class="notification-list" id="notificationList"><div class="empty-state" style="padding: 20px;"><p>Sen notificaci√≥ns</p></div></div>
    </div>
    <div class="fab-container">
        <button class="fab fab-transfer" id="fabTransfer">‚áÑ</button>
        <button class="fab fab-income" id="fabIncome">+</button>
        <button class="fab fab-expense" id="fabExpense">‚àí</button>
    </div>
    <div class="app-container">
        <header>
            <div class="piggy-icon">üê∑</div>
            <h1 class="logo">CARTI√ëOS</h1>
            <p class="subtitle">Xesti√≥n Financeira</p>
        </header>
        <div class="alert-box" id="alertBox"><div class="alert-title">‚ö†Ô∏è Erro</div><div id="alertMessage"></div></div>
        <div class="main-display">
            <div class="main-display-content">
                <div class="available-label">Di√±eiro dispo√±ible hoxe</div>
                <div class="available-amount" id="availableAmount">0,00 ‚Ç¨</div>
                <div class="secondary-amount">Sen aforro: <span id="availableWithoutSavings">0,00 ‚Ç¨</span></div>
                <div class="secondary-info">
                    <div class="info-item"><div class="info-label">Saldo Total</div><div class="info-value" id="totalBalance">0,00 ‚Ç¨</div></div>
                    <div class="info-item"><div class="info-label">Aforro</div><div class="info-value" id="totalSavings">0,00 ‚Ç¨</div></div>
                    <div class="info-item"><div class="info-label">Comprometido</div><div class="info-value" id="committedAmount">0,00 ‚Ç¨</div></div>
                    <div class="info-item"><div class="info-label">D√≠a</div><div class="info-value" id="currentDay">1</div></div>
                </div>
            </div>
        </div>
        <nav class="nav-tabs" id="navTabs">
            <button class="nav-tab active" data-section="dashboard">Panel</button>
            <button class="nav-tab" data-section="accounts">Contas</button>
            <button class="nav-tab" data-section="incomes">Ingresos</button>
            <button class="nav-tab" data-section="expenses">Gastos</button>
            <button class="nav-tab" data-section="recurring">Fixos</button>
            <button class="nav-tab" data-section="savings">Aforro</button>
            <button class="nav-tab" data-section="debts">D√©bedas</button>
            <button class="nav-tab" data-section="simulator">Simulador</button>
            <button class="nav-tab" data-section="analysis">An√°lise</button>
            <button class="nav-tab" data-section="settings">Axustes</button>
        </nav>
        <!-- SECTIONS -->
        <section class="section active" id="section-dashboard">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="statIncomeMonth" style="color: var(--accent-green)">0,00 ‚Ç¨</div><div class="stat-label">Ingresos mes</div></div>
                <div class="stat-card"><div class="stat-value" id="statExpenseMonth" style="color: var(--accent-pink)">0,00 ‚Ç¨</div><div class="stat-label">Gastos mes</div></div>
                <div class="stat-card"><div class="stat-value" id="statRecurring" style="color: var(--accent-yellow)">0,00 ‚Ç¨</div><div class="stat-label">Fixos pendentes</div></div>
                <div class="stat-card"><div class="stat-value" id="statDailyAvg" style="color: var(--accent-cyan)">0,00 ‚Ç¨</div><div class="stat-label">Media diaria</div></div>
            </div>
            <div class="card"><div class="card-header"><h2 class="card-title">üìä Evoluci√≥n</h2></div><div class="chart-container"><canvas id="dashboardChart"></canvas></div></div>
            <div class="card"><div class="card-header"><h2 class="card-title">üïê Movementos</h2></div><div id="recentMovements"><div class="empty-state"><div class="empty-state-icon">üìä</div><p>Sen movementos</p></div></div></div>
        </section>
        <section class="section" id="section-accounts">
            <div class="card">
                <div class="card-header"><h2 class="card-title">üè¶ Contas</h2><button class="btn btn-primary" id="btnNewAccount">+ Nova</button></div>
                <div id="accountsList"><div class="empty-state"><div class="empty-state-icon">üè¶</div><p>Engade a t√∫a primeira conta</p></div></div>
            </div>
        </section>
        <section class="section" id="section-incomes">
            <div class="card">
                <div class="card-header"><h2 class="card-title">üí∞ Ingresos</h2><button class="btn btn-primary" id="btnNewIncome">+ Novo</button></div>
                <div id="incomesList"><div class="empty-state"><div class="empty-state-icon">üí∞</div><p>Rexistra ingresos</p></div></div>
            </div>
        </section>
        <section class="section" id="section-expenses">
            <div class="card">
                <div class="card-header"><h2 class="card-title">üõí Gastos</h2><button class="btn btn-primary" id="btnNewExpense">+ Novo</button></div>
                <div id="expensesList"><div class="empty-state"><div class="empty-state-icon">üõí</div><p>Rexistra gastos</p></div></div>
            </div>
        </section>
        <section class="section" id="section-recurring">
            <div class="card">
                <div class="card-header"><h2 class="card-title">üîÑ Gastos Fixos</h2><button class="btn btn-primary" id="btnNewRecurring">+ Novo</button></div>
                <div id="recurringList"><div class="empty-state"><div class="empty-state-icon">üîÑ</div><p>Configura gastos fixos</p></div></div>
            </div>
        </section>
        <section class="section" id="section-savings">
            <div class="card">
                <div class="card-header"><h2 class="card-title">üéØ Metas</h2><button class="btn btn-primary" id="btnNewSavings">+ Nova</button></div>
                <div id="savingsAlerts"></div>
                <div id="savingsList"><div class="empty-state"><div class="empty-state-icon">üéØ</div><p>Define metas de aforro</p></div></div>
            </div>
        </section>
        <section class="section" id="section-debts">
            <div class="card">
                <div class="card-header"><h2 class="card-title">üí≥ D√©bedas</h2><button class="btn btn-primary" id="btnNewDebt">+ Nova</button></div>
                <p style="color: var(--text-muted); margin-bottom: 12px; font-size: 0.8rem;">‚ÑπÔ∏è Non afectan ao dispo√±ible</p>
                <div id="debtsList"><div class="empty-state"><div class="empty-state-icon">üí≥</div><p>Rexistra d√©bedas</p></div></div>
            </div>
        </section>
        <section class="section" id="section-simulator">
            <div class="card">
                <div class="card-header"><h2 class="card-title">üîÆ Simulador</h2></div>
                <div class="simulator-horizon" id="horizonBtns">
                    <button class="horizon-btn active" data-months="3">3m</button>
                    <button class="horizon-btn" data-months="6">6m</button>
                    <button class="horizon-btn" data-months="12">1a</button>
                    <button class="horizon-btn" data-months="24">2a</button>
                    <button class="horizon-btn" data-months="60">5a</button>
                </div>
                <div id="simulatorAlerts"></div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="simBalance" style="color: var(--accent-cyan)">0,00 ‚Ç¨</div><div class="stat-label">Saldo</div></div>
                    <div class="stat-card"><div class="stat-value" id="simSavings" style="color: var(--accent-green)">0,00 ‚Ç¨</div><div class="stat-label">Aforro</div></div>
                </div>
                <div class="chart-container"><canvas id="simulatorChart"></canvas></div>
            </div>
        </section>
        <section class="section" id="section-analysis">
            <div class="card"><div class="card-header"><h2 class="card-title">üîç Patr√≥ns</h2></div><div id="patternAnalysis"><div class="empty-state"><div class="empty-state-icon">üîç</div><p>Neces√≠tanse m√°is datos</p></div></div></div>
            <div class="card"><div class="card-header"><h2 class="card-title">üìà Comparativa</h2></div><div class="chart-container"><canvas id="comparisonChart"></canvas></div></div>
            <div class="card"><div class="card-header"><h2 class="card-title">üìä Categor√≠as</h2></div><div class="chart-container" style="height: 220px;"><canvas id="categoryChart"></canvas></div></div>
        </section>
        <section class="section" id="section-settings">
            <div class="card">
                <div class="card-header"><h2 class="card-title">üíæ Datos</h2></div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="btnExportJSON">JSON</button>
                    <button class="btn btn-secondary" id="btnExportPDF">PDF</button>
                    <button class="btn btn-secondary" id="btnImport">Importar</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                    <button class="btn btn-danger" id="btnReset">Borrar</button>
                </div>
            </div>
            <div class="card"><div class="card-header"><h2 class="card-title">‚öôÔ∏è Estado</h2></div><div id="systemStatus"></div></div>
           <div class="card"><div class="card-header"><h2 class="card-title">‚ÑπÔ∏è Informaci√≥n</h2></div>
                <p style="color: var(--text-secondary); line-height: 1.8;"><strong>Carti√±os </strong><br>Xesti√≥n financeira persoal en galego.<br>Feito con  üíô dende Galicia.<br>Biqui√±os  üòò</p>
            </div>
        </section>
    </div>
    <!-- MODALS -->
    <div class="modal-overlay" id="accountModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Nova Conta</h3><button class="modal-close" data-close="accountModal">&times;</button></div>
            <form id="accountForm">
                <div class="form-group"><label class="form-label">Nome</label><input type="text" class="form-input" name="name" placeholder="Ex: Conta Principal" required></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Saldo</label><input type="number" class="form-input" name="balance" placeholder="0.00" step="0.01" required></div>
                    <div class="form-group"><label class="form-label">Tipo</label><select class="form-select" name="accountType"><option value="bank">üè¶ Banco</option><option value="cash">üíµ Efectivo</option></select></div>
                </div>
                <div class="form-group"><div class="checkbox-container" id="checkDailySpending"><div class="checkbox-custom checked"></div><span>Para gasto diario</span></div></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Gardar</button>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="incomeModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Novo Ingreso</h3><button class="modal-close" data-close="incomeModal">&times;</button></div>
            <form id="incomeForm">
                <div class="form-group"><label class="form-label">Descrici√≥n</label><input type="text" class="form-input" name="description" placeholder="Ex: N√≥mina" required></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Cantidade</label><input type="number" class="form-input" name="amount" placeholder="0.00" step="0.01" required></div>
                    <div class="form-group"><label class="form-label">Data</label><input type="date" class="form-input" name="date" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Tipo</label><select class="form-select" name="incomeType"><option value="regular">üíº Regular</option><option value="extra">üéÅ Extra</option></select></div>
                    <div class="form-group"><label class="form-label">Conta</label><select class="form-select" name="accountId" required></select></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Gardar</button>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="expenseModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Novo Gasto</h3><button class="modal-close" data-close="expenseModal">&times;</button></div>
            <form id="expenseForm">
                <div class="form-group"><label class="form-label">Descrici√≥n</label><input type="text" class="form-input" name="description" placeholder="Ex: Supermercado" required></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Cantidade</label><input type="number" class="form-input" name="amount" placeholder="0.00" step="0.01" required></div>
                    <div class="form-group"><label class="form-label">Data</label><input type="date" class="form-input" name="date" required></div>
                </div>
                <div class="form-group"><label class="form-label">Categor√≠a</label><select class="form-select" name="category"><option value="alimentacion">üçé Alimentaci√≥n</option><option value="transporte">üöó Transporte</option><option value="ocio">üéÆ Ocio</option><option value="saude">üíä Sa√∫de</option><option value="roupa">üëï Roupa</option><option value="cafe">‚òï Caf√©/Snacks</option><option value="subscricions">üì± Subscrici√≥ns</option><option value="outros">üì¶ Outros</option></select></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Gardar</button>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="recurringModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Novo Gasto Fixo</h3><button class="modal-close" data-close="recurringModal">&times;</button></div>
            <form id="recurringForm">
                <div class="form-group"><label class="form-label">Descrici√≥n</label><input type="text" class="form-input" name="description" placeholder="Ex: Aluguer" required></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Cantidade</label><input type="number" class="form-input" name="amount" placeholder="0.00" step="0.01" required></div>
                    <div class="form-group"><label class="form-label">D√≠a do mes</label><input type="number" class="form-input" name="dayOfMonth" min="1" max="31" placeholder="1-31" required></div>
                </div>
                <div class="form-group"><label class="form-label">Categor√≠a</label><select class="form-select" name="category"><option value="vivienda">üè† Vivenda</option><option value="servicios">üí° Servizos</option><option value="seguros">üõ°Ô∏è Seguros</option><option value="subscricions">üì± Subscrici√≥ns</option><option value="outros">üì¶ Outros</option></select></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Gardar</button>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="savingsModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Nova Meta</h3><button class="modal-close" data-close="savingsModal">&times;</button></div>
            <form id="savingsForm">
                <div class="form-group"><label class="form-label">Nome</label><input type="text" class="form-input" name="name" placeholder="Ex: Vacaci√≥ns" required></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Obxectivo</label><input type="number" class="form-input" name="targetAmount" placeholder="0.00" step="0.01" required></div>
                    <div class="form-group"><label class="form-label">Data l√≠mite</label><input type="date" class="form-input" name="targetDate"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Aforro/d√≠a</label><input type="number" class="form-input" name="dailyAmount" placeholder="0.00" step="0.01" required></div>
                    <div class="form-group"><label class="form-label">Xa aforrado</label><input type="number" class="form-input" name="currentAmount" placeholder="0.00" step="0.01" value="0"></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Gardar</button>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="debtModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Nova D√©beda</h3><button class="modal-close" data-close="debtModal">&times;</button></div>
            <form id="debtForm">
                <div class="debt-direction" id="debtDirection">
                    <button type="button" class="debt-direction-btn active" data-direction="owe"><span class="icon">üì§</span>Debo</button>
                    <button type="button" class="debt-direction-btn" data-direction="owed"><span class="icon">üì•</span>D√©benme</button>
                </div>
                <input type="hidden" name="direction" value="owe">
                <div class="form-group"><label class="form-label">Persoa</label><input type="text" class="form-input" name="person" placeholder="Ex: Mar√≠a" required></div>
                <div class="form-group"><label class="form-label">Concepto</label><input type="text" class="form-input" name="concept" placeholder="Ex: Cea" required></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Cantidade</label><input type="number" class="form-input" name="amount" placeholder="0.00" step="0.01" required></div>
                    <div class="form-group"><label class="form-label">Xa pagado</label><input type="number" class="form-input" name="paidAmount" placeholder="0.00" step="0.01" value="0"></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Gardar</button>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="transferModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Transferencia</h3><button class="modal-close" data-close="transferModal">&times;</button></div>
            <form id="transferForm">
                <div class="form-group"><label class="form-label">Dende</label><select class="form-select" name="fromAccount" required></select></div>
                <div class="form-group"><label class="form-label">Cara a</label><select class="form-select" name="toAccount" required></select></div>
                <div class="form-group"><label class="form-label">Cantidade</label><input type="number" class="form-input" name="amount" placeholder="0.00" step="0.01" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Transferir</button>
            </form>
        </div>
    </div>
    <div class="toast-container" id="toastContainer"></div>
    <script>
    // MOTOR FINANCEIRO
    const FinancialEngine = (function() {
        function calculateAvailableToday(data) {
            const today = new Date(); today.setHours(0,0,0,0);
            const currentDay = today.getDate(), currentMonth = today.getMonth(), currentYear = today.getFullYear();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const remainingDays = daysInMonth - currentDay + 1;
            const dailySpendingBalance = (data.accounts||[]).filter(a=>a&&a.forDailySpending).reduce((s,a)=>s+(parseFloat(a.balance)||0),0);
            const committedRecurring = (data.recurringExpenses||[]).filter(e=>e&&(parseInt(e.dayOfMonth)||1)>currentDay).reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
            let incomesUntilToday = 0;
            (data.incomes||[]).forEach(inc=>{
                if(!inc||!inc.date)return;
                const d = new Date(inc.date);
                if(d.getMonth()!==currentMonth||d.getFullYear()!==currentYear||d>today)return;
                const amt = parseFloat(inc.amount)||0;
                incomesUntilToday += inc.incomeType==='extra'&&remainingDays>0 ? amt/remainingDays : amt;
            });
            const dailyExpensesTotal = (data.expenses||[]).filter(e=>{if(!e||!e.date)return false;const d=new Date(e.date);return d.getMonth()===currentMonth&&d.getFullYear()===currentYear;}).reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
            const dailySavingsAmount = (data.savingsGoals||[]).filter(g=>g&&g.active!==false).reduce((s,g)=>s+(parseFloat(g.dailyAmount)||0),0);
            const availableToday = dailySpendingBalance - committedRecurring + incomesUntilToday - dailyExpensesTotal - dailySavingsAmount;
            return {
                availableToday: r2(availableToday),
                availableWithoutSavings: r2(availableToday + dailySavingsAmount),
                breakdown: { dailySpendingBalance: r2(dailySpendingBalance), committedRecurring: r2(committedRecurring), incomesUntilToday: r2(incomesUntilToday), dailyExpensesTotal: r2(dailyExpensesTotal), dailySavingsAmount: r2(dailySavingsAmount) }
            };
        }
        function calculateTotalBalance(accounts) { return r2((accounts||[]).reduce((s,a)=>s+(parseFloat(a.balance)||0),0)); }
        function calculateTotalSavings(goals) { return r2((goals||[]).reduce((s,g)=>s+(parseFloat(g.currentAmount)||0),0)); }
        function calculateMonthlyStats(data) {
            const today = new Date(), cm = today.getMonth(), cy = today.getFullYear(), cd = today.getDate();
            const mi = (data.incomes||[]).filter(i=>{if(!i||!i.date)return false;const d=new Date(i.date);return d.getMonth()===cm&&d.getFullYear()===cy;}).reduce((s,i)=>s+(parseFloat(i.amount)||0),0);
            const me = (data.expenses||[]).filter(e=>{if(!e||!e.date)return false;const d=new Date(e.date);return d.getMonth()===cm&&d.getFullYear()===cy;}).reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
            const pr = (data.recurringExpenses||[]).filter(e=>(parseInt(e.dayOfMonth)||1)<=cd).reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
            const pend = (data.recurringExpenses||[]).filter(e=>(parseInt(e.dayOfMonth)||1)>cd).reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
            return { monthlyIncomes: r2(mi), monthlyExpenses: r2(me), paidRecurring: r2(pr), pendingRecurring: r2(pend), totalMonthlyExpenses: r2(me+pr), dailyAverage: r2(cd>0?(me+pr)/cd:0) };
        }
        function simulateFinances(data, months) {
            const stats = calculateMonthlyStats(data);
            const tb = calculateTotalBalance(data.accounts);
            const ds = (data.savingsGoals||[]).filter(g=>g&&g.active!==false).reduce((s,g)=>s+(parseFloat(g.dailyAmount)||0),0);
            const ts = calculateTotalSavings(data.savingsGoals);
            const mi = stats.monthlyIncomes||0, mexp = stats.totalMonthlyExpenses+(stats.dailyAverage*30-stats.totalMonthlyExpenses)||0;
            const ms = ds*30, mn = mi - mexp - ms;
            const proj = []; let rb = tb, rsv = ts, negM = null, risk = false;
            for(let i=1;i<=months;i++){ rb+=mn; rsv+=ms; proj.push({month:i,balance:r2(rb),savings:r2(rsv)}); if(rb<0&&negM===null)negM=i; }
            (data.savingsGoals||[]).forEach(g=>{ if(g.targetDate){ const t=new Date(g.targetDate),n=new Date(),mt=(t.getFullYear()-n.getFullYear())*12+(t.getMonth()-n.getMonth()); if((g.currentAmount||0)+(g.dailyAmount||0)*30*mt<g.targetAmount)risk=true; }});
            return { projections: proj, finalBalance: r2(rb), finalSavings: r2(rsv), totalExpenses: r2(mexp*months), negativeMonth: negM, savingsGoalAtRisk: risk, monthlyNet: r2(mn) };
        }
        function detectPatterns(data) {
            const patterns = [], now = new Date(), cm = now.getMonth(), cy = now.getFullYear();
            const tme = (data.expenses||[]).filter(e=>{const d=new Date(e.date);return d.getMonth()===cm&&d.getFullYear()===cy;});
            const small = tme.filter(e=>parseFloat(e.amount)<=5&&['cafe','ocio','alimentacion'].includes(e.category));
            if(small.length>=5){ patterns.push({icon:'üêú',title:'Gastos Formiga',description:`${small.length} gastos pequenos (‚â§5‚Ç¨):`,amount:small.reduce((s,e)=>s+parseFloat(e.amount),0),suggestion:'Reduce gastos pequenos'}); }
            const bc = {}; tme.forEach(e=>{bc[e.category]=(bc[e.category]||0)+parseFloat(e.amount);});
            const tc = Object.entries(bc).sort((a,b)=>b[1]-a[1])[0];
            if(tc&&tc[1]>0){ const cn={alimentacion:'Alimentaci√≥n',transporte:'Transporte',ocio:'Ocio',saude:'Sa√∫de',roupa:'Roupa',cafe:'Caf√©',subscricions:'Subscrici√≥ns',outros:'Outros'}; patterns.push({icon:'üìä',title:'Categor√≠a Principal',description:`${cn[tc[0]]||tc[0]}:`,amount:tc[1],suggestion:'Revisa esta √°rea'}); }
            return patterns;
        }
        function recalculateSavingsGoals(goals) {
            const today = new Date(), updates = [];
            (goals||[]).forEach(g=>{ if(!g.targetDate||!g.targetAmount)return; const t=new Date(g.targetDate),dr=Math.ceil((t-today)/(1000*60*60*24)); if(dr<=0)return; const rem=g.targetAmount-(g.currentAmount||0),req=rem/dr; if(req>(g.dailyAmount||0)*1.1)updates.push({id:g.id,name:g.name,currentDaily:g.dailyAmount,requiredDaily:r2(req)}); });
            return updates;
        }
        function r2(n){ return typeof n!=='number'||isNaN(n)?0:Math.round(n*100)/100; }
        return { calculateAvailableToday, calculateTotalBalance, calculateTotalSavings, calculateMonthlyStats, simulateFinances, detectPatterns, recalculateSavingsGoals, r2 };
    })();
    // TESTS
    const TestSystem = (function() {
        const tests = [
            ['F√≥rmula v√°lida', d=>{ const r=FinancialEngine.calculateAvailableToday(d); return typeof r.availableToday==='number'&&!isNaN(r.availableToday); }],
            ['Breakdown coherente', d=>{ const r=FinancialEngine.calculateAvailableToday(d),b=r.breakdown; return Math.abs(b.dailySpendingBalance-b.committedRecurring+b.incomesUntilToday-b.dailyExpensesTotal-b.dailySavingsAmount-r.availableToday)<0.01; }]
        ];
        let lastResults = null;
        function runAllTests(data) {
            const results = tests.map(([name,fn])=>{ try{ return {name,passed:fn(data)}; }catch(e){ return {name,passed:false}; }});
            lastResults = { allPassed: results.every(r=>r.passed), results };
            return lastResults;
        }
        return { runAllTests, getLastResults: ()=>lastResults };
    })();
    // DATABASE
    const Database = (function() {
        const DB_NAME='dinheiroDB', DB_VERSION=2;
        let db = null;
        const STORES = ['accounts','incomes','expenses','recurringExpenses','savingsGoals','debts','transfers','notifications'];
        function open() {
            return new Promise((resolve,reject)=>{
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onerror = ()=>reject(req.error);
                req.onsuccess = ()=>{ db=req.result; resolve(db); };
                req.onupgradeneeded = e=>{ const d=e.target.result; STORES.forEach(s=>{ if(!d.objectStoreNames.contains(s))d.createObjectStore(s,{keyPath:'id',autoIncrement:true}); }); };
            });
        }
        function getAll(store) { return new Promise((res,rej)=>{ const r=db.transaction(store).objectStore(store).getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>rej(r.error); }); }
        function add(store,data) { return new Promise((res,rej)=>{ const r=db.transaction(store,'readwrite').objectStore(store).add({...data,createdAt:new Date().toISOString()}); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
        function update(store,data) { return new Promise((res,rej)=>{ const r=db.transaction(store,'readwrite').objectStore(store).put({...data,updatedAt:new Date().toISOString()}); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
        function remove(store,id) { return new Promise((res,rej)=>{ const r=db.transaction(store,'readwrite').objectStore(store).delete(id); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
        function clear(store) { return new Promise((res,rej)=>{ const r=db.transaction(store,'readwrite').objectStore(store).clear(); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
        async function clearAll() { for(const s of STORES) await clear(s); }
        async function getAllData() { const d={}; for(const s of STORES) d[s]=await getAll(s); return d; }
        return { open, getAll, add, update, remove, clear, clearAll, getAllData, STORES };
    })();
    // STATE
    let AppState = { accounts:[],incomes:[],expenses:[],recurringExpenses:[],savingsGoals:[],debts:[],transfers:[],notifications:[],lastCalculation:null };
    let charts = {};
    // UI HELPERS
    const $ = id => document.getElementById(id);
    const fc = n => (parseFloat(n)||0).toLocaleString('gl-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨';
    const fd = d => new Date(d).toLocaleDateString('gl-ES',{day:'2-digit',month:'2-digit',year:'numeric'});
    function toast(msg, type='success') {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = `<div class="toast-message">${msg}</div>`;
        $('toastContainer').appendChild(t);
        setTimeout(()=>t.remove(), 3500);
    }
    // iOS body scroll lock variables
    let scrollPosition = 0;
    function openModal(id) {
        // iOS scroll lock
        scrollPosition = window.pageYOffset;
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.top = `-${scrollPosition}px`;
        document.body.style.width = '100%';
        $(id).classList.add('active');
        updateAccountSelects();
        document.querySelectorAll(`#${id} input[type="date"]`).forEach(i=>{ if(!i.value) i.value = new Date().toISOString().split('T')[0]; });
    }
    function closeModal(id) {
        $(id).classList.remove('active');
        // iOS scroll unlock
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('position');
        document.body.style.removeProperty('top');
        document.body.style.removeProperty('width');
        window.scrollTo(0, scrollPosition);
        $(id).querySelector('form')?.reset();
        document.querySelectorAll('.debt-direction-btn').forEach((b,i)=>b.classList.toggle('active',i===0));
        $('debtForm').direction.value = 'owe';
    }
    function switchSection(name) {
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
        $(`section-${name}`).classList.add('active');
        document.querySelector(`[data-section="${name}"]`).classList.add('active');
        if(name==='simulator') updateSimulator();
        if(name==='analysis') updateAnalysis();
    }
    function updateAccountSelects() {
        document.querySelectorAll('select[name="accountId"],select[name="fromAccount"],select[name="toAccount"]').forEach(sel=>{
            const cv = sel.value;
            sel.innerHTML = '<option value="">Selecciona</option>' + AppState.accounts.map(a=>`<option value="${a.id}">${a.name} (${fc(a.balance)})</option>`).join('');
            sel.value = cv;
        });
    }
    // UI UPDATES
    function updateMainDisplay() {
        const r = FinancialEngine.calculateAvailableToday(AppState);
        AppState.lastCalculation = r;
        const el = $('availableAmount');
        el.textContent = fc(r.availableToday);
        el.className = 'available-amount' + (r.availableToday<0?' negative':r.availableToday>50?' positive':'');
        $('availableWithoutSavings').textContent = fc(r.availableWithoutSavings);
        $('totalBalance').textContent = fc(FinancialEngine.calculateTotalBalance(AppState.accounts));
        $('totalSavings').textContent = fc(FinancialEngine.calculateTotalSavings(AppState.savingsGoals));
        $('committedAmount').textContent = fc(r.breakdown.committedRecurring);
        $('currentDay').textContent = new Date().getDate();
        const s = FinancialEngine.calculateMonthlyStats(AppState);
        $('statIncomeMonth').textContent = fc(s.monthlyIncomes);
        $('statExpenseMonth').textContent = fc(s.totalMonthlyExpenses);
        $('statRecurring').textContent = fc(s.pendingRecurring);
        $('statDailyAvg').textContent = fc(s.dailyAverage);
    }
    function updateAccountsList() {
        const c = $('accountsList');
        if(!AppState.accounts.length){ c.innerHTML='<div class="empty-state"><div class="empty-state-icon">üè¶</div><p>Engade a t√∫a primeira conta</p></div>'; return; }
        c.innerHTML = AppState.accounts.map(a=>`<div class="list-item"><div class="list-item-info"><div class="list-item-name">${a.name}<span class="tag tag-${a.accountType||'bank'}">${a.accountType==='cash'?'üíµ':'üè¶'}</span></div><div class="list-item-details">${a.forDailySpending?'‚úì Gasto diario':'‚óã Reserva'}</div></div><div class="list-item-amount ${parseFloat(a.balance)>=0?'income':'expense'}">${fc(a.balance)}</div><div class="list-item-actions"><button class="btn btn-danger btn-icon" data-delete="account" data-id="${a.id}">‚úï</button></div></div>`).join('');
    }
    function updateIncomesList() {
        const c = $('incomesList'), now = new Date();
        const items = AppState.incomes.filter(i=>{const d=new Date(i.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();}).sort((a,b)=>new Date(b.date)-new Date(a.date));
        if(!items.length){ c.innerHTML='<div class="empty-state"><div class="empty-state-icon">üí∞</div><p>Rexistra ingresos</p></div>'; return; }
        c.innerHTML = items.map(i=>`<div class="list-item" style="border-left-color:var(--accent-green)"><div class="list-item-info"><div class="list-item-name">${i.description}${i.incomeType==='extra'?'<span class="tag tag-extra">Extra</span>':''}</div><div class="list-item-details">${fd(i.date)}</div></div><div class="list-item-amount income">+${fc(i.amount)}</div><div class="list-item-actions"><button class="btn btn-danger btn-icon" data-delete="income" data-id="${i.id}">‚úï</button></div></div>`).join('');
    }
    function updateExpensesList() {
        const c = $('expensesList'), now = new Date();
        const cats = {alimentacion:'üçé',transporte:'üöó',ocio:'üéÆ',saude:'üíä',roupa:'üëï',cafe:'‚òï',subscricions:'üì±',outros:'üì¶'};
        const items = AppState.expenses.filter(e=>{const d=new Date(e.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();}).sort((a,b)=>new Date(b.date)-new Date(a.date));
        if(!items.length){ c.innerHTML='<div class="empty-state"><div class="empty-state-icon">üõí</div><p>Rexistra gastos</p></div>'; return; }
        c.innerHTML = items.map(e=>`<div class="list-item"><div class="list-item-info"><div class="list-item-name">${e.description}</div><div class="list-item-details">${fd(e.date)} ¬∑ ${cats[e.category]||'üì¶'}</div></div><div class="list-item-amount expense">-${fc(e.amount)}</div><div class="list-item-actions"><button class="btn btn-danger btn-icon" data-delete="expense" data-id="${e.id}">‚úï</button></div></div>`).join('');
    }
    function updateRecurringList() {
        const c = $('recurringList'), today = new Date().getDate();
        const cats = {vivienda:'üè†',servicios:'üí°',seguros:'üõ°Ô∏è',subscricions:'üì±',outros:'üì¶'};
        if(!AppState.recurringExpenses.length){ c.innerHTML='<div class="empty-state"><div class="empty-state-icon">üîÑ</div><p>Configura gastos fixos</p></div>'; return; }
        c.innerHTML = AppState.recurringExpenses.sort((a,b)=>a.dayOfMonth-b.dayOfMonth).map(r=>{const paid=r.dayOfMonth<=today;return `<div class="list-item" style="border-left-color:${paid?'var(--accent-green)':'var(--accent-yellow)'}"><div class="list-item-info"><div class="list-item-name">${r.description}</div><div class="list-item-details">D√≠a ${r.dayOfMonth} ¬∑ ${cats[r.category]||'üì¶'} ¬∑ ${paid?'‚úì Pagado':'‚óã Pendente'}</div></div><div class="list-item-amount expense">-${fc(r.amount)}</div><div class="list-item-actions"><button class="btn btn-danger btn-icon" data-delete="recurring" data-id="${r.id}">‚úï</button></div></div>`;}).join('');
    }
    function updateSavingsList() {
        const c = $('savingsList'), ac = $('savingsAlerts');
        const recalc = FinancialEngine.recalculateSavingsGoals(AppState.savingsGoals);
        ac.innerHTML = recalc.length ? recalc.map(r=>`<div class="simulator-alert warning"><span class="simulator-alert-icon">‚ö†Ô∏è</span><div class="simulator-alert-text"><strong>${r.name}</strong>: Necesitas ${fc(r.requiredDaily)}/d√≠a<button class="btn btn-secondary" style="margin-left:8px;padding:5px 8px;min-height:30px;font-size:0.7rem;" data-recalc="${r.id}" data-daily="${r.requiredDaily}">Axustar</button></div></div>`).join('') : '';
        if(!AppState.savingsGoals.length){ c.innerHTML='<div class="empty-state"><div class="empty-state-icon">üéØ</div><p>Define metas</p></div>'; return; }
        c.innerHTML = AppState.savingsGoals.map(g=>{const p=g.targetAmount>0?(g.currentAmount/g.targetAmount)*100:0,dr=g.dailyAmount>0?Math.ceil((g.targetAmount-g.currentAmount)/g.dailyAmount):'‚àû',pc=p<30?'danger':p<70?'warning':'success';return `<div class="list-item" style="flex-direction:column;align-items:stretch;border-left-color:var(--accent-purple)"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><div class="list-item-info"><div class="list-item-name">${g.name}</div><div class="list-item-details">${fc(g.dailyAmount)}/d√≠a ¬∑ ~${dr} d√≠as</div></div><div style="text-align:right;margin-right:8px;"><div class="list-item-amount income">${fc(g.currentAmount)}</div><div class="list-item-details">de ${fc(g.targetAmount)}</div></div><button class="btn btn-danger btn-icon" data-delete="savings" data-id="${g.id}">‚úï</button></div><div class="progress-bar"><div class="progress-fill ${pc}" style="width:${Math.min(p,100)}%"></div></div></div>`;}).join('');
    }
    function updateDebtsList() {
        const c = $('debtsList');
        if(!AppState.debts.length){ c.innerHTML='<div class="empty-state"><div class="empty-state-icon">üí≥</div><p>Rexistra d√©bedas</p></div>'; return; }
        const owe = AppState.debts.filter(d=>d.direction==='owe'), owed = AppState.debts.filter(d=>d.direction==='owed');
        let h = '';
        if(owe.length){ h+='<h4 style="color:var(--accent-pink);margin:10px 0;font-size:0.85rem;">üì§ DEBO:</h4>'+owe.map(d=>{const p=d.amount>0?((d.paidAmount||0)/d.amount)*100:0,rem=d.amount-(d.paidAmount||0);return `<div class="list-item" style="border-left-color:var(--accent-pink)"><div class="list-item-info"><div class="list-item-name">${d.person}</div><div class="list-item-details">${d.concept}</div><div class="progress-bar" style="margin-top:6px;height:4px;"><div class="progress-fill" style="width:${p}%"></div></div></div><div style="text-align:right;margin-right:8px;"><div class="list-item-amount expense">${fc(rem)}</div></div><div class="list-item-actions"><button class="btn btn-success btn-icon" data-pay="${d.id}">üí∏</button><button class="btn btn-danger btn-icon" data-delete="debt" data-id="${d.id}">‚úï</button></div></div>`;}).join(''); }
        if(owed.length){ h+='<h4 style="color:var(--accent-green);margin:15px 0 10px;font-size:0.85rem;">üì• D√âBENME:</h4>'+owed.map(d=>{const p=d.amount>0?((d.paidAmount||0)/d.amount)*100:0,rem=d.amount-(d.paidAmount||0);return `<div class="list-item" style="border-left-color:var(--accent-green)"><div class="list-item-info"><div class="list-item-name">${d.person}</div><div class="list-item-details">${d.concept}</div><div class="progress-bar" style="margin-top:6px;height:4px;"><div class="progress-fill success" style="width:${p}%"></div></div></div><div style="text-align:right;margin-right:8px;"><div class="list-item-amount income">${fc(rem)}</div></div><div class="list-item-actions"><button class="btn btn-success btn-icon" data-receive="${d.id}">üí∞</button><button class="btn btn-danger btn-icon" data-delete="debt" data-id="${d.id}">‚úï</button></div></div>`;}).join(''); }
        c.innerHTML = h;
    }
    function updateRecentMovements() {
        const c = $('recentMovements');
        const all = [...AppState.incomes.map(i=>({...i,type:'income'})),...AppState.expenses.map(e=>({...e,type:'expense'})),...(AppState.transfers||[]).map(t=>({...t,type:'transfer',description:`${t.description||'Transferencia'}`}))].sort((a,b)=>new Date(b.date||b.createdAt)-new Date(a.date||a.createdAt)).slice(0,6);
        if(!all.length){ c.innerHTML='<div class="empty-state"><div class="empty-state-icon">üìä</div><p>Sen movementos</p></div>'; return; }
        c.innerHTML = all.map(m=>`<div class="list-item" style="border-left-color:${m.type==='income'?'var(--accent-green)':m.type==='transfer'?'var(--accent-cyan)':'var(--accent-pink)'}"><div class="list-item-info"><div class="list-item-name">${m.description}</div><div class="list-item-details">${fd(m.date||m.createdAt)}</div></div><div class="list-item-amount ${m.type==='income'?'income':m.type==='transfer'?'neutral':'expense'}">${m.type==='income'?'+':m.type==='transfer'?'‚áÑ':'-'}${fc(m.amount)}</div></div>`).join('');
    }
    function updateSystemStatus() {
        const tr = TestSystem.getLastResults();
        $('systemStatus').innerHTML = `<div style="display:grid;gap:6px;"><div style="display:flex;justify-content:space-between;padding:8px 10px;background:rgba(10,10,26,0.6);border-radius:6px;font-size:0.85rem;"><span>Base de datos</span><span style="color:var(--accent-green);">‚úì</span></div><div style="display:flex;justify-content:space-between;padding:8px 10px;background:rgba(10,10,26,0.6);border-radius:6px;font-size:0.85rem;"><span>Tests</span><span style="color:${tr?.allPassed?'var(--accent-green)':'#ff4757'};">${tr?.allPassed?'‚úì':'‚úï'}</span></div><div style="display:flex;justify-content:space-between;padding:8px 10px;background:rgba(10,10,26,0.6);border-radius:6px;font-size:0.85rem;"><span>Contas</span><span>${AppState.accounts.length}</span></div></div>`;
    }
    function updateNotificationUI() {
        const badge = $('notifBadge'), list = $('notificationList');
        const unread = AppState.notifications.filter(n=>!n.read).length;
        badge.textContent = unread; badge.classList.toggle('hidden', unread===0);
        if(!AppState.notifications.length){ list.innerHTML='<div class="empty-state" style="padding:20px;"><p>Sen notificaci√≥ns</p></div>'; return; }
        list.innerHTML = AppState.notifications.slice(0,15).map(n=>`<div class="notification-item ${n.read?'':'unread'}" data-notif="${n.id}"><div class="notification-item-title"><span class="notif-icon notif-${n.type}">${n.icon}</span>${n.title}</div><div class="notification-item-text">${n.text}</div></div>`).join('');
    }
    // CHARTS
    function updateDashboardChart() {
        const ctx = $('dashboardChart'); if(!ctx) return;
        const now = new Date(), cd = now.getDate();
        const labels=[],incD=[],expD=[],balD=[];
        let ri=0,re=0;
        for(let d=1;d<=cd;d++){
            labels.push(d);
            const di = AppState.incomes.filter(i=>{const dt=new Date(i.date);return dt.getDate()===d&&dt.getMonth()===now.getMonth()&&dt.getFullYear()===now.getFullYear();}).reduce((s,i)=>s+parseFloat(i.amount),0);
            const de = AppState.expenses.filter(e=>{const dt=new Date(e.date);return dt.getDate()===d&&dt.getMonth()===now.getMonth()&&dt.getFullYear()===now.getFullYear();}).reduce((s,e)=>s+parseFloat(e.amount),0);
            const dr = AppState.recurringExpenses.filter(r=>r.dayOfMonth===d).reduce((s,r)=>s+parseFloat(r.amount),0);
            ri+=di; re+=de+dr; incD.push(ri); expD.push(re); balD.push(ri-re);
        }
        if(charts.dashboard) charts.dashboard.destroy();
        charts.dashboard = new Chart(ctx, {type:'line',data:{labels,datasets:[{label:'Ingresos',data:incD,borderColor:'#39ff14',backgroundColor:'rgba(57,255,20,0.1)',fill:true,tension:0.4},{label:'Gastos',data:expD,borderColor:'#ff6ec7',backgroundColor:'rgba(255,110,199,0.1)',fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#a0a0c0',font:{size:10}}}},scales:{x:{ticks:{color:'#606080',font:{size:9}},grid:{color:'rgba(255,110,199,0.1)'}},y:{ticks:{color:'#606080',font:{size:9}},grid:{color:'rgba(255,110,199,0.1)'}}}}});
    }
    function updateSimulator() {
        const activeBtn = document.querySelector('.horizon-btn.active');
        const months = parseInt(activeBtn?.dataset.months)||3;
        const sim = FinancialEngine.simulateFinances(AppState, months);
        $('simBalance').textContent = fc(sim.finalBalance);
        $('simSavings').textContent = fc(sim.finalSavings);
        let alerts = '';
        if(sim.negativeMonth) alerts += `<div class="simulator-alert danger"><span class="simulator-alert-icon">üö®</span><div class="simulator-alert-text">Saldo negativo no mes ${sim.negativeMonth}</div></div>`;
        if(sim.savingsGoalAtRisk) alerts += `<div class="simulator-alert warning"><span class="simulator-alert-icon">‚ö†Ô∏è</span><div class="simulator-alert-text">Meta de aforro en risco</div></div>`;
        if(!sim.negativeMonth&&!sim.savingsGoalAtRisk&&sim.monthlyNet>=0) alerts += `<div class="simulator-alert success"><span class="simulator-alert-icon">‚úÖ</span><div class="simulator-alert-text">Todo ben! Neto: ${fc(sim.monthlyNet)}/mes</div></div>`;
        $('simulatorAlerts').innerHTML = alerts;
        const ctx = $('simulatorChart'); if(charts.simulator) charts.simulator.destroy();
        charts.simulator = new Chart(ctx, {type:'line',data:{labels:sim.projections.map(p=>`M${p.month}`),datasets:[{label:'Saldo',data:sim.projections.map(p=>p.balance),borderColor:'#00f5ff',backgroundColor:'rgba(0,245,255,0.2)',fill:true,tension:0.4},{label:'Aforro',data:sim.projections.map(p=>p.savings),borderColor:'#39ff14',backgroundColor:'rgba(57,255,20,0.2)',fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#a0a0c0',font:{size:10}}}},scales:{x:{ticks:{color:'#606080',font:{size:9}},grid:{color:'rgba(255,110,199,0.1)'}},y:{ticks:{color:'#606080',font:{size:9}},grid:{color:'rgba(255,110,199,0.1)'}}}}});
    }
    function updateAnalysis() {
        const patterns = FinancialEngine.detectPatterns(AppState);
        const pc = $('patternAnalysis');
        pc.innerHTML = patterns.length ? patterns.map(p=>`<div class="pattern-card"><div class="pattern-header"><span class="pattern-icon">${p.icon}</span><span class="pattern-title">${p.title}</span></div><p class="pattern-description">${p.description}${p.amount?` <span class="pattern-amount">${fc(p.amount)}</span>`:''}</p><p style="color:var(--accent-cyan);font-size:0.8rem;margin-top:6px;">üí° ${p.suggestion}</p></div>`).join('') : '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>Neces√≠tanse m√°is datos</p></div>';
        updateComparisonChart(); updateCategoryChart();
    }
    function updateComparisonChart() {
        const ctx = $('comparisonChart'); if(!ctx) return;
        const now = new Date(), mn=['Xan','Feb','Mar','Abr','Mai','Xu√±','Xul','Ago','Set','Out','Nov','Dec'];
        const months = []; for(let i=2;i>=0;i--){ const d=new Date(now.getFullYear(),now.getMonth()-i,1); months.push({m:d.getMonth(),y:d.getFullYear(),l:mn[d.getMonth()]}); }
        const iD=[],eD=[];
        months.forEach(m=>{ iD.push(AppState.incomes.filter(i=>{const d=new Date(i.date);return d.getMonth()===m.m&&d.getFullYear()===m.y;}).reduce((s,i)=>s+parseFloat(i.amount),0)); const rec=AppState.recurringExpenses.reduce((s,r)=>s+parseFloat(r.amount),0); eD.push(AppState.expenses.filter(e=>{const d=new Date(e.date);return d.getMonth()===m.m&&d.getFullYear()===m.y;}).reduce((s,e)=>s+parseFloat(e.amount),0)+rec); });
        if(charts.comparison) charts.comparison.destroy();
        charts.comparison = new Chart(ctx, {type:'bar',data:{labels:months.map(m=>m.l),datasets:[{label:'Ingresos',data:iD,backgroundColor:'rgba(57,255,20,0.7)'},{label:'Gastos',data:eD,backgroundColor:'rgba(255,110,199,0.7)'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#a0a0c0',font:{size:10}}}},scales:{x:{ticks:{color:'#606080'},grid:{color:'rgba(255,110,199,0.1)'}},y:{ticks:{color:'#606080'},grid:{color:'rgba(255,110,199,0.1)'}}}}});
    }
    function updateCategoryChart() {
        const ctx = $('categoryChart'); if(!ctx) return;
        const now = new Date(), ct={}, cc={alimentacion:'#ff6ec7',transporte:'#00f5ff',ocio:'#a855f7',saude:'#39ff14',roupa:'#ffd93d',cafe:'#ff9f43',subscricions:'#74b9ff',outros:'#636e72'}, cn={alimentacion:'Alim.',transporte:'Trans.',ocio:'Ocio',saude:'Sa√∫de',roupa:'Roupa',cafe:'Caf√©',subscricions:'Subs.',outros:'Outros'};
        AppState.expenses.filter(e=>{const d=new Date(e.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();}).forEach(e=>{ct[e.category]=(ct[e.category]||0)+parseFloat(e.amount);});
        if(charts.category) charts.category.destroy();
        if(!Object.keys(ct).length){ ctx.parentElement.innerHTML='<div class="empty-state"><p>Sen datos</p></div>'; return; }
        charts.category = new Chart(ctx, {type:'doughnut',data:{labels:Object.keys(ct).map(c=>cn[c]||c),datasets:[{data:Object.values(ct),backgroundColor:Object.keys(ct).map(c=>cc[c]||'#636e72'),borderColor:'#1a1a3a',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#a0a0c0',font:{size:9},padding:8}}}}});
    }
    // CRUD
    async function saveAccount(e) {
        e.preventDefault();
        const f = e.target, cb = f.querySelector('.checkbox-custom');
        const data = { name:f.name.value, balance:parseFloat(f.balance.value)||0, accountType:f.accountType.value, forDailySpending:cb.classList.contains('checked') };
        const id = await Database.add('accounts', data);
        AppState.accounts.push({...data, id});
        closeModal('accountModal'); updateAllUI(); runTests(); toast('Conta gardada ‚úì');
    }
    async function saveIncome(e) {
        e.preventDefault();
        const f = e.target;
        const data = { description:f.description.value, amount:parseFloat(f.amount.value)||0, date:f.date.value, incomeType:f.incomeType.value, accountId:parseInt(f.accountId.value) };
        const id = await Database.add('incomes', data);
        AppState.incomes.push({...data, id});
        closeModal('incomeModal'); updateAllUI(); runTests(); toast(data.incomeType==='extra'?'Ingreso extra repartido üéÅ':'Ingreso gardado ‚úì');
    }
    async function saveExpense(e) {
        e.preventDefault();
        const f = e.target;
        const data = { description:f.description.value, amount:parseFloat(f.amount.value)||0, date:f.date.value, category:f.category.value };
        const id = await Database.add('expenses', data);
        AppState.expenses.push({...data, id});
        closeModal('expenseModal'); updateAllUI(); runTests();
        if(AppState.lastCalculation && data.amount > AppState.lastCalculation.availableToday * 0.5) addNotification('warning','Gasto Alto',`"${data.description}" supera o 50%`,'‚ö†Ô∏è');
        toast('Gasto gardado ‚úì');
    }
    async function saveRecurring(e) {
        e.preventDefault();
        const f = e.target;
        const data = { description:f.description.value, amount:parseFloat(f.amount.value)||0, dayOfMonth:parseInt(f.dayOfMonth.value)||1, category:f.category.value };
        const id = await Database.add('recurringExpenses', data);
        AppState.recurringExpenses.push({...data, id});
        closeModal('recurringModal'); updateAllUI(); runTests(); toast('Gasto fixo gardado ‚úì');
    }
    async function saveSavingsGoal(e) {
        e.preventDefault();
        const f = e.target;
        const data = { name:f.name.value, targetAmount:parseFloat(f.targetAmount.value)||0, targetDate:f.targetDate.value||null, dailyAmount:parseFloat(f.dailyAmount.value)||0, currentAmount:parseFloat(f.currentAmount.value)||0, active:true };
        const id = await Database.add('savingsGoals', data);
        AppState.savingsGoals.push({...data, id});
        closeModal('savingsModal'); updateAllUI(); runTests(); toast('Meta creada ‚úì');
    }
    async function saveDebt(e) {
        e.preventDefault();
        const f = e.target;
        const data = { direction:f.direction.value, person:f.person.value, concept:f.concept.value, amount:parseFloat(f.amount.value)||0, paidAmount:parseFloat(f.paidAmount.value)||0 };
        const id = await Database.add('debts', data);
        AppState.debts.push({...data, id, createdAt:new Date().toISOString()});
        closeModal('debtModal'); updateAllUI(); toast('D√©beda gardada ‚úì');
    }
    async function saveTransfer(e) {
        e.preventDefault();
        const f = e.target, fid = parseInt(f.fromAccount.value), tid = parseInt(f.toAccount.value), amt = parseFloat(f.amount.value)||0;
        if(fid===tid){ toast('Contas deben ser diferentes','error'); return; }
        const fa = AppState.accounts.find(a=>a.id===fid), ta = AppState.accounts.find(a=>a.id===tid);
        if(!fa||!ta){ toast('Selecciona contas','error'); return; }
        fa.balance -= amt; ta.balance += amt;
        await Database.update('accounts', fa); await Database.update('accounts', ta);
        const tr = { fromAccountId:fid, toAccountId:tid, amount:amt, description:`${fa.name}‚Üí${ta.name}`, date:new Date().toISOString() };
        const id = await Database.add('transfers', tr);
        AppState.transfers.push({...tr, id});
        closeModal('transferModal'); updateAllUI(); toast(`Transferido ${fc(amt)} ‚úì`);
    }
    async function deleteItem(type, id) {
        const stores = { account:'accounts', income:'incomes', expense:'expenses', recurring:'recurringExpenses', savings:'savingsGoals', debt:'debts' };
        const stateKeys = { account:'accounts', income:'incomes', expense:'expenses', recurring:'recurringExpenses', savings:'savingsGoals', debt:'debts' };
        await Database.remove(stores[type], id);
        AppState[stateKeys[type]] = AppState[stateKeys[type]].filter(i=>i.id!==id);
        updateAllUI(); runTests();
    }
    async function payDebt(id, receive=false) {
        const debt = AppState.debts.find(d=>d.id===id); if(!debt) return;
        const rem = debt.amount - (debt.paidAmount||0);
        const amt = prompt(`Cantidade (pendente: ${fc(rem)}):`, rem);
        if(amt===null) return;
        debt.paidAmount = (debt.paidAmount||0) + (parseFloat(amt)||0);
        await Database.update('debts', debt);
        updateAllUI();
        if(debt.paidAmount>=debt.amount){ toast(receive?`${debt.person} saldou! üéâ`:'D√©beda saldada! üéâ'); addNotification('success','D√©beda Completada',receive?`${debt.person} pagou`:'Pagaches a d√©beda','‚úÖ'); }
        else toast('Pagamento rexistrado ‚úì');
    }
    async function autoRecalcSavings(id, daily) {
        const g = AppState.savingsGoals.find(x=>x.id===id); if(!g) return;
        g.dailyAmount = daily;
        await Database.update('savingsGoals', g);
        updateAllUI(); toast(`Axustado a ${fc(daily)}/d√≠a ‚úì`);
    }
    function addNotification(type, title, text, icon='üì¢') {
        AppState.notifications.unshift({ id:Date.now(), type, title, text, icon, time:new Date().toISOString(), read:false });
        if(AppState.notifications.length>30) AppState.notifications = AppState.notifications.slice(0,30);
        updateNotificationUI();
    }
    // EXPORT/IMPORT
    async function exportJSON() {
        const data = { version:'2.0.0', exportedAt:new Date().toISOString(), accounts:AppState.accounts, incomes:AppState.incomes, expenses:AppState.expenses, recurringExpenses:AppState.recurringExpenses, savingsGoals:AppState.savingsGoals, debts:AppState.debts, transfers:AppState.transfers };
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `cartinos_${new Date().toISOString().split('T')[0]}.json`; a.click();
        toast('Exportado ‚úì');
    }
    async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF(), r = FinancialEngine.calculateAvailableToday(AppState);
        doc.setFillColor(26,26,58); doc.rect(0,0,210,30,'F');
        doc.setTextColor(255,110,199); doc.setFontSize(18); doc.text('CARTI√ëOS',105,15,{align:'center'});
        doc.setTextColor(160,160,192); doc.setFontSize(9); doc.text('Informe Financeiro',105,23,{align:'center'});
        doc.setTextColor(60,60,60); doc.setFontSize(10); doc.text(`Data: ${new Date().toLocaleDateString('gl-ES')}`,20,40);
        doc.setFontSize(14); doc.text(`Dispo√±ible hoxe: ${fc(r.availableToday)}`,20,55);
        doc.save(`cartinos_${new Date().toISOString().split('T')[0]}.pdf`);
        toast('PDF exportado ‚úì');
    }
    async function importData(e) {
        const file = e.target.files[0]; if(!file) return;
        try {
            const data = JSON.parse(await file.text());
            if(!data.version) throw new Error('Formato inv√°lido');
            await Database.clearAll();
            for(const a of (data.accounts||[])) { delete a.id; await Database.add('accounts',a); }
            for(const i of (data.incomes||[])) { delete i.id; await Database.add('incomes',i); }
            for(const x of (data.expenses||[])) { delete x.id; await Database.add('expenses',x); }
            for(const r of (data.recurringExpenses||[])) { delete r.id; await Database.add('recurringExpenses',r); }
            for(const s of (data.savingsGoals||[])) { delete s.id; await Database.add('savingsGoals',s); }
            for(const d of (data.debts||[])) { delete d.id; await Database.add('debts',d); }
            for(const t of (data.transfers||[])) { delete t.id; await Database.add('transfers',t); }
            await loadData(); toast('Importado ‚úì');
        } catch(err) { toast('Erro: '+err.message,'error'); }
        e.target.value = '';
    }
    async function resetData() {
        if(!confirm('Borrar TODOS os datos?')) return;
        if(!confirm('Confirmas?')) return;
        await Database.clearAll();
        AppState = { accounts:[],incomes:[],expenses:[],recurringExpenses:[],savingsGoals:[],debts:[],transfers:[],notifications:[],lastCalculation:null };
        updateAllUI(); toast('Datos borrados','warning');
    }
    // CORE
    function runTests() {
        const r = TestSystem.runAllTests(AppState);
        const el = $('testStatus');
        el.className = 'test-status ' + (r.allPassed?'pass':'fail');
        el.textContent = r.allPassed?'‚úì':'‚úï';
    }
    function updateAllUI() {
        updateMainDisplay(); updateAccountsList(); updateIncomesList(); updateExpensesList();
        updateRecurringList(); updateSavingsList(); updateDebtsList(); updateRecentMovements();
        updateSystemStatus(); updateNotificationUI(); updateDashboardChart();
    }
    async function loadData() {
        const d = await Database.getAllData();
        AppState.accounts = d.accounts||[]; AppState.incomes = d.incomes||[]; AppState.expenses = d.expenses||[];
        AppState.recurringExpenses = d.recurringExpenses||[]; AppState.savingsGoals = d.savingsGoals||[];
        AppState.debts = d.debts||[]; AppState.transfers = d.transfers||[]; AppState.notifications = d.notifications||[];
    }
    // INITIALIZATION
    async function init() {
        try {
            await Database.open();
            await loadData();
            runTests();
            updateAllUI();

            // Navigation tabs
            $('navTabs').addEventListener('click', e => {
                const tab = e.target.closest('.nav-tab');
                if(tab) switchSection(tab.dataset.section);
            });

            // FAB buttons
            $('fabIncome').addEventListener('click', () => openModal('incomeModal'));
            $('fabExpense').addEventListener('click', () => openModal('expenseModal'));
            $('fabTransfer').addEventListener('click', () => openModal('transferModal'));

            // Section buttons
            $('btnNewAccount')?.addEventListener('click', () => openModal('accountModal'));
            $('btnNewIncome')?.addEventListener('click', () => openModal('incomeModal'));
            $('btnNewExpense')?.addEventListener('click', () => openModal('expenseModal'));
            $('btnNewRecurring')?.addEventListener('click', () => openModal('recurringModal'));
            $('btnNewSavings')?.addEventListener('click', () => openModal('savingsModal'));
            $('btnNewDebt')?.addEventListener('click', () => openModal('debtModal'));

            // Settings buttons
            $('btnExportJSON')?.addEventListener('click', exportJSON);
            $('btnExportPDF')?.addEventListener('click', exportPDF);
            $('btnImport')?.addEventListener('click', () => $('importFile').click());
            $('importFile')?.addEventListener('change', importData);
            $('btnReset')?.addEventListener('click', resetData);

            // Forms
            $('accountForm').addEventListener('submit', saveAccount);
            $('incomeForm').addEventListener('submit', saveIncome);
            $('expenseForm').addEventListener('submit', saveExpense);
            $('recurringForm').addEventListener('submit', saveRecurring);
            $('savingsForm').addEventListener('submit', saveSavingsGoal);
            $('debtForm').addEventListener('submit', saveDebt);
            $('transferForm').addEventListener('submit', saveTransfer);

            // Checkbox toggle
            $('checkDailySpending').addEventListener('click', function() {
                this.querySelector('.checkbox-custom').classList.toggle('checked');
            });

            // Debt direction
            $('debtDirection').addEventListener('click', e => {
                const btn = e.target.closest('.debt-direction-btn');
                if(btn) {
                    document.querySelectorAll('.debt-direction-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    $('debtForm').direction.value = btn.dataset.direction;
                }
            });

            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => closeModal(btn.dataset.close));
            });

            // Modal overlay click to close
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', e => {
                    if(e.target === overlay) overlay.classList.remove('active');
                });
            });

            // Horizon buttons
            $('horizonBtns').addEventListener('click', e => {
                const btn = e.target.closest('.horizon-btn');
                if(btn) {
                    document.querySelectorAll('.horizon-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateSimulator();
                }
            });

            // Notification bell
            $('notifBell').addEventListener('click', () => {
                $('notificationPanel').classList.toggle('active');
            });
            $('clearNotifsBtn').addEventListener('click', () => {
                AppState.notifications = [];
                updateNotificationUI();
            });

            // Close notification panel on outside click
            document.addEventListener('click', e => {
                const panel = $('notificationPanel'), bell = $('notifBell');
                if(!panel.contains(e.target) && !bell.contains(e.target)) {
                    panel.classList.remove('active');
                }
            });

            // Delegated events for dynamic content
            document.addEventListener('click', async e => {
                // Delete buttons
                const delBtn = e.target.closest('[data-delete]');
                if(delBtn) {
                    const type = delBtn.dataset.delete;
                    const id = parseInt(delBtn.dataset.id);
                    if(confirm('Eliminar?')) await deleteItem(type, id);
                    return;
                }

                // Pay debt
                const payBtn = e.target.closest('[data-pay]');
                if(payBtn) {
                    await payDebt(parseInt(payBtn.dataset.pay), false);
                    return;
                }

                // Receive debt payment
                const recvBtn = e.target.closest('[data-receive]');
                if(recvBtn) {
                    await payDebt(parseInt(recvBtn.dataset.receive), true);
                    return;
                }

                // Recalculate savings
                const recalcBtn = e.target.closest('[data-recalc]');
                if(recalcBtn) {
                    await autoRecalcSavings(parseInt(recalcBtn.dataset.recalc), parseFloat(recalcBtn.dataset.daily));
                    return;
                }

                // Mark notification as read
                const notifItem = e.target.closest('[data-notif]');
                if(notifItem) {
                    const n = AppState.notifications.find(x => x.id === parseInt(notifItem.dataset.notif));
                    if(n) n.read = true;
                    updateNotificationUI();
                    return;
                }
            });

            // Hide splash screen
            const splash = $('splashScreen');
            if(splash) {
                splash.style.transition = 'opacity 0.3s ease';
                splash.style.opacity = '0';
                setTimeout(() => splash.remove(), 300);
            }

            // iOS Standalone Mode Optimizations
            if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
                document.documentElement.classList.add('standalone');
                // Prevent pull-to-refresh in standalone
                document.body.addEventListener('touchmove', function(e) {
                    if (e.target.closest('.notification-list, .modal-overlay')) return;
                    if (window.scrollY === 0 && e.touches[0].clientY > 0) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }

            // iOS keyboard handling - scroll input into view
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.addEventListener('focus', function() {
                    setTimeout(() => {
                        this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });

            // Prevent double-tap zoom on buttons
            document.querySelectorAll('button, .btn, .nav-tab, .fab').forEach(el => {
                el.addEventListener('touchend', e => {
                    e.preventDefault();
                    el.click();
                });
            });

            // Welcome toast
            setTimeout(() => {
                const r = FinancialEngine.calculateAvailableToday(AppState);
                if(r.availableToday > 0) toast(`Hoxe podes gastar ${fc(r.availableToday)} üí∞`, 'info');
                else if(r.availableToday < 0) toast(`Atenci√≥n: ${fc(r.availableToday)} üö®`, 'warning');
            }, 1000);

        } catch(e) {
            console.error('Init error:', e);
            toast('Erro ao iniciar: ' + e.message, 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
